<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Live Stream</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />

    <link rel="stylesheet" href="css/style.css" />
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand fw-bold" href="/">
          <i class="fas fa-rocket me-2"></i>Plataforma
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto"></ul>
        </div>
      </div>
    </nav>

    <main class="container my-5">
      <div class="auth-container animate__animated animate__fadeIn">
        <div class="auth-header">
          <h2>
            <i class="fas fa-desktop text-primary me-2"></i>Criar Stream
            Executável
          </h2>

          <p class="text-muted">
            Configure os detalhes para o seu arquivo de stream.
          </p>
        </div>

        <form id="streamForm">
          <div class="mb-3">
            <label for="streamName" class="form-label">Nome do Stream</label>

            <input
              type="text"
              class="form-control"
              id="streamName"
              placeholder="Ex: Minha Live Incrível"
              minlength="6"
              required
            />
          </div>

          <div class="mb-3">
            <label for="streamPassword" class="form-label"
              >Senha do Stream (Obrigatória)</label
            >

            <div class="input-group">
              <input
                type="password"
                class="form-control"
                id="streamPassword"
                placeholder="Mínimo 6 caracteres (Obrigatório)"
                minlength="6"
                required
              />

              <span
                class="input-group-text text-danger"
                data-bs-toggle="tooltip"
                title="A senha é obrigatória por segurança."
              >
                <i class="fas fa-exclamation-triangle"></i>
              </span>
            </div>
          </div>

          <div class="d-grid gap-2 mt-4">
            <button
              type="submit"
              class="btn btn-primary btn-lg"
              id="generateExeButton"
            >
              <i class="fas fa-magic me-2"></i>Gerar Stream.exe
            </button>
          </div>
        </form>
      </div>
    </main>

    <footer class="bg-primary text-white py-4">
      <div class="container text-center">
        <p class="mb-0">
          © 2025 Valdir de Souza. Todos os direitos reservados.
        </p>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script src="../js/createStream.js"></script>

    <script>
      // 1. Script para inicializar o tooltip
      document.addEventListener("DOMContentLoaded", function () {
        // Inicializa tooltips do Bootstrap
        const tooltipTriggerList = [].slice.call(
          document.querySelectorAll('[data-bs-toggle="tooltip"]')
        );
        tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });
      });
    </script>

    <script>
      // 2. Script para a lógica de formulário, geração do .exe e tratamento de erro 403
      document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("streamForm");
        const button = document.getElementById("generateExeButton");
        const streamNameInput = document.getElementById("streamName");
        const streamPasswordInput = document.getElementById("streamPassword");

        const originalButtonText =
          '<i class="fas fa-magic me-2"></i>Gerar Stream.exe';
        let loadingInterval;

        const loadingMessages = [
          "Gerando .exe",
          "Aguarde mais um pouco",
          "Compilando .exe",
        ];
        let messageIndex = 0;

        const spinner = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>`;

        function updateLoadingMessage() {
          button.innerHTML = spinner + loadingMessages[messageIndex];
          messageIndex = (messageIndex + 1) % loadingMessages.length;
        }

        function startLoading() {
          button.disabled = true;
          messageIndex = 0;
          updateLoadingMessage();

          loadingInterval = setInterval(updateLoadingMessage, 5000);
        }

        function stopLoading() {
          clearInterval(loadingInterval);
          button.disabled = false;
          button.innerHTML = originalButtonText;
        }

        form.addEventListener("submit", function (event) {
          event.preventDefault();

          if (form.checkValidity()) {
            startLoading();

            const streamData = {
              streamName: streamNameInput.value,
              streamPassword: streamPasswordInput.value,
            };

            // Substitua pelo endpoint real que gera o executável
            const apiUrl = "/createStreamExe";

            // SIMULAÇÃO: Tempo de espera reduzido para 1 segundo para teste
            setTimeout(async () => {
              try {
                // SIMULAÇÃO: COLOQUE SEU FETCH REAL AQUI
                // const response = await fetch(apiUrl, {
                //   method: 'POST',
                //   body: JSON.stringify(streamData),
                //   headers: { 'Content-Type': 'application/json' }
                // });

                // Simulação de resposta (Altere o statusSimulado para testar 403 ou 200)
                const statusSimulado = 200; // Altere para 403 para testar o erro

                if (statusSimulado === 403) {
                  // TRATAMENTO DO ERRO 403 (Stream Duplicado/Recurso Proibido)
                  const errorMessage = `O Stream com o nome **"${streamData.streamName}"** já existe em sua conta. Por favor, escolha outro nome.`;
                  alert(errorMessage);
                  console.error("Erro 403: Stream Duplicado");

                  button.innerHTML =
                    '<i class="fas fa-exclamation-circle me-2"></i>Erro 403';
                  setTimeout(stopLoading, 3000);
                } else if (statusSimulado === 200) {
                  // SUCESSO (Status 200 OK)
                  console.log("Executável Gerado! (Simulação concluída)");
                  // Exibir sucesso e restaurar
                  button.innerHTML =
                    '<i class="fas fa-check-circle me-2"></i>Concluído!';
                  setTimeout(stopLoading, 3000);
                } else {
                  // Outros erros HTTP
                  throw new Error(`Erro HTTP: ${statusSimulado}`);
                }
              } catch (error) {
                console.error("Erro na geração do executável:", error);
                alert(`Ocorreu um erro: ${error.message}. Tente novamente.`);
                button.innerHTML =
                  '<i class="fas fa-times-circle me-2"></i>Falha!';
                setTimeout(stopLoading, 3000);
              } finally {
                clearInterval(loadingInterval); // Garante que o intervalo seja parado
              }
            }, 1000); // Tempo de espera para simulação
          } else {
            form.classList.add("was-validated");
          }
        });
      });
    </script>

    <script>
      // 3. Script para verificação de login e atualização da barra de navegação
      const buttonsLoginRegister = (logged) => {
        const SignIn = `<li class="nav-item">
            <a class="nav-link" href="login.html"
            ><i class="fas fa-sign-in-alt me-1"></i> Login</a
            >
            </li>`;

        const SignUp = `<li class="nav-item">
              <a class="nav-link" href="register.html"
              ><i class="fas fa-user-plus me-1"></i> Cadastro</a
              >
              </li>`;

        const loginOn = `<li class="nav-item">
                <a class="nav-link" href="myProfile.html"
                ><i class="fas fa-user me-1"></i> Meu perfil</a
                >
                </li>`;
        const navItem = document.createElement("li");
        const navBar = document.querySelector(".navbar-nav");
        if (logged) {
          navItem.innerHTML = loginOn;
          navBar.appendChild(navItem);
        } else {
          navItem.innerHTML = SignIn;
          const navItemSignUp = document.createElement("li");
          navItemSignUp.innerHTML = SignUp;
          navBar.appendChild(navItem);
          navBar.appendChild(navItemSignUp);
        }
        // Este navBar.appendChild(navItem); estava duplicado e foi ajustado na versão anterior,
        // mas foi deixado o código base do usuário para o fluxo de login/register.
        // Apenas para garantir a funcionalidade original:
        // navBar.appendChild(navItem);
      };

      document.addEventListener("DOMContentLoaded", async () => {
        let logged;
        // Tenta buscar o status de login
        try {
          const r = await fetch("/verifyUser");
          logged = await r.text();
          logged = logged === "false" ? false : true;
        } catch (error) {
          console.error("Erro ao verificar usuário:", error);
          logged = false;
        }

        // Tenta refresh do token se não estiver logado
        if (!logged) {
          try {
            const response = await fetch("/refreshToken");
            const responseJson = await response.json();

            logged = !(responseJson.message === "unauthorized");
          } catch (error) {
            console.log("Falha no refresh do token.");
            logged = false;
          }
        }

        buttonsLoginRegister(logged);
      });
    </script>
  </body>
</html>
